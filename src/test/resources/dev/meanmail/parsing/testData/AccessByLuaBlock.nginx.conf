location / {
    deny  192.168.1.1;
    allow 192.168.1.0/24;
    allow 10.1.1.0/16;
    deny  all;

    access_by_lua_block {
        local res = ngx.location.capture("/mysql", { ... })
        ...
    }

    # proxy_pass/fastcgi_pass/...
}

location / {
    auth_request /auth;

    # proxy_pass/fastcgi_pass/postgres_pass/...
}

location / {
    access_by_lua_block {
                     local res = ngx.location.capture("/auth")

                     if res.status == ngx.HTTP_OK then
                         return
                     end

                     if res.status == ngx.HTTP_FORBIDDEN then
                         ngx.exit(res.status)
                     end

                     ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
    }

    # proxy_pass/fastcgi_pass/postgres_pass/...
}
