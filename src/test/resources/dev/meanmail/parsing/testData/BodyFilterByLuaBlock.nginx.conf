location / {
    proxy_pass http://mybackend;
    body_filter_by_lua_block {
                     ngx.arg[1] = string.upper(ngx.arg[1])
    }
}

location /t {
    echo hello world;
    echo hiya  globe;

    body_filter_by_lua_block {
                     local chunk = ngx.arg[1]
                     if string.match(chunk, "hello") then
                         ngx.arg[2] = true  -- new eof
                         return
                     end

                     -- just throw away any remaining chunk data
                     ngx.arg[1] = nil
    }
}

location /foo {
    # fastcgi_pass/proxy_pass/...

    header_filter_by_lua_block {
                     ngx.header.content_length = nil
    }
    body_filter_by_lua_block {
                     ngx.arg[1] = string.len(ngx.arg[1]) .. "\n"
    }
}
