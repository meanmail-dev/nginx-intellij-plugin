lua_capture_error_log 100k;

lua_malloc_trim 0;  # turn off trimming completely


init_by_lua '
 print("I need no extra escaping here, for example: \r\nblah")
';


# this runs before forking out nginx worker processes:
init_by_lua_block {
 require "cjson"
}

server {
    location = /api {
        content_by_lua_block {
                                 -- the following require() will just  return
                                 -- the already loaded module from package.loaded:
                                 ngx.say(require "cjson".encode{dog = 5, cat = 6})
        }
    }
}

lua_shared_dict dogs 1m;

init_by_lua_block {
 local dogs = ngx.shared.dogs
 dogs:set("Tom", 56)
}

server {
    location = /api {
        content_by_lua_block {
                                 local dogs = ngx.shared.dogs
                                 ngx.say(dogs:get("Tom"))
        }
    }
}

init_worker_by_lua '
 print("I need no extra escaping here, for example: \r\nblah")
';
