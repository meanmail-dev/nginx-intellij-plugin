# ngx_stream_num_map_module example
# https://nginx.org/en/docs/stream/ngx_stream_num_map_module.html

stream {
    # Map connection port to backend
    num_map $server_port $backend {
        default   backend_default:8080;
        80        backend_http:80;
        443       backend_https:443;
        8080-8089 backend_dev:8080;
        9000-9999 backend_test:9000;
    }

    # Map bytes received to connection type
    num_map $bytes_received $connection_type {
        default      "heavy";
        0-1024       "light";
        1025-10240   "normal";
        10241-102400 "moderate";
    }

    # Map upstream connect time to health status
    num_map $upstream_connect_time $upstream_health {
        volatile;
        default  "critical";
        0-10     "healthy";
        11-50    "degraded";
        51-200   "slow";
    }

    # Using include for external mappings
    num_map $remote_port $client_priority {
        default "normal";
        include /etc/nginx/priority_map.conf;
    }

    upstream backend_default {
        server 127.0.0.1:8080;
    }

    upstream backend_http {
        server 127.0.0.1:80;
    }

    upstream backend_https {
        server 127.0.0.1:443;
    }

    upstream backend_dev {
        server 127.0.0.1:8080;
    }

    upstream backend_test {
        server 127.0.0.1:9000;
    }

    server {
        listen     12345;
        proxy_pass $backend;
    }
}
