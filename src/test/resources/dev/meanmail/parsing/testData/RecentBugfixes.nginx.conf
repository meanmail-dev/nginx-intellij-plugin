# Regression tests for recent bugfixes (a73b0a8..HEAD)
# All directives below should parse without errors.

# ============================================================
# Issue #53: Unquoted string value with `=` in map directive
# https://github.com/meanmail-dev/nginx-intellij-plugin/issues/53
# ============================================================

map $request_uri $append_args {
    default &a=1;
    ~^/old /new?redirect=true;
    /path &x=1&y=2;
}

# ============================================================
# Issue #54: Unquoted string with trailing `=` in query strings
# https://github.com/meanmail-dev/nginx-intellij-plugin/issues/54
# ============================================================

server {
    listen 80;

    location / {
        try_files $uri /index.php?=;
    }

    location /search {
        try_files $uri /index.php?q=;
    }

    location /app {
        try_files $uri /index.php?key=value&b=;
    }
}

# ============================================================
# Issue #55: error_page directive context (allow in `if`)
# https://github.com/meanmail-dev/nginx-intellij-plugin/issues/55
# ============================================================

server {
    listen 80;

    location / {
        if ($request_method = POST) {
            error_page 405 /method_not_allowed.html;
        }
    }
}

# ============================================================
# Issue #56: memcached_pass directive context
# https://github.com/meanmail-dev/nginx-intellij-plugin/issues/56
# ============================================================

server {
    listen 80;

    location / {
        memcached_pass 127.0.0.1:11211;
    }

    location /cached {
        if ($request_method = GET) {
            memcached_pass 127.0.0.1:11211;
        }
    }
}

# ============================================================
# Issue #51: Unquoted URL in proxy_pass with variable and multiple =
# https://github.com/meanmail-dev/nginx-intellij-plugin/issues/51
# ============================================================

server {
    listen 80;

    location / {
        proxy_pass http://backend/forbidden.html?v=$arg_v&a=2;
    }

    location /api {
        proxy_pass http://backend/path?token=$arg_token&format=json&page=1;
    }

    location /search {
        proxy_pass http://backend/search?q=$arg_q&lang=en&limit=10;
    }
}

# ============================================================
# Issue #50: Unquoted URL in rewrite with # (hash/fragment)
# https://github.com/meanmail-dev/nginx-intellij-plugin/issues/50
# ============================================================

server {
    listen 80;

    error_page 403 http://example.com/forbidden.html?v=1&a=2;
    if ($args ~ "tt") {
        rewrite ^ http://example.com/forbidden.html#tt? break;
    }
}
