location /foo {
    set  $a         12; # create and initialize $a
    set  $b         ""; # create and initialize $b
    rewrite_by_lua_block {
                     ngx.var.b = tonumber(ngx.var.a) + 1
    }
    echo "res = $b";
}

location /foo {
    set $a 12; # create and initialize $a
    set $b ''; # create and initialize $b
    rewrite_by_lua_block {
                     ngx.var.b = tonumber(ngx.var.a) + 1
                     if tonumber(ngx.var.b) == 13 then
                         return ngx.redirect("/bar")
                     end
    }

    echo "res = $b";
}

location / {
    eval $res {
        proxy_pass http://foo.com/check-spam;
    }

    if ($res = 'spam') {
        rewrite ^ /terms-of-use.html redirect;
    }

    fastcgi_pass ...;
}

location = /check-spam {
    internal;
    proxy_pass http://foo.com/check-spam;
}

location / {
    rewrite_by_lua_block {
                     local res = ngx.location.capture("/check-spam")
                     if res.body == "spam" then
                         return ngx.redirect("/terms-of-use.html")
                     end
    }

    fastcgi_pass ...;
}

location /foo {
    rewrite ^ /bar;
    rewrite_by_lua_block {
                     ngx.exit(503)
    }
}
