# ngx_http_tunnel_module example
# https://nginx.org/en/docs/http/ngx_http_tunnel_module.html

http {
    # Buffer size for tunnel connections
    tunnel_buffer_size 16k;

    # Timeout for establishing connection with backend
    tunnel_connect_timeout 60s;

    # Timeout between read/write operations
    tunnel_read_timeout 60s;

    # Timeout for sending to backend
    tunnel_send_timeout 60s;

    # TCP keepalive for outgoing connections
    tunnel_socket_keepalive on;

    # Minimize send operations
    tunnel_send_lowat 0;

    # Pass to next server on error or timeout
    tunnel_next_upstream error timeout;

    # Limit time for passing to next server
    tunnel_next_upstream_timeout 0;

    # Limit number of tries
    tunnel_next_upstream_tries 0;

    server {
        listen 3128;

        # Allow CONNECT to specific hosts
        tunnel_allow_upstream $host;

        # Bind outgoing connections to specific address
        tunnel_bind 192.168.1.1;

        # Dynamic bind at each connection attempt
        tunnel_bind_dynamic on;

        location / {
            # Enable CONNECT request handling
            tunnel_pass;
        }

        location /proxy {
            # Pass to specific backend
            tunnel_pass backend.example.com:443;
        }
    }
}
